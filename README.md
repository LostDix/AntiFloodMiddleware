# AntiFloodMiddleware | –ê–Ω—Ç–∏—Ñ–ª—É–¥-–º–∏–¥–ª–≤–∞—Ä—å –¥–ª—è Telegram –±–æ—Ç–∞: –∑–∞—â–∏—Ç–∞ –æ—Ç —Å–ø–∞–º–∞
–≠—Ç–æ—Ç –∫–æ–¥ —Ä–µ–∞–ª–∏–∑—É–µ—Ç middleware –¥–ª—è Telegram –±–æ—Ç–∞, –∫–æ—Ç–æ—Ä—ã–π –∑–∞—â–∏—â–∞–µ—Ç –æ—Ç —Ñ–ª—É–¥–∞ - —Å–ª–∏—à–∫–æ–º —á–∞—Å—Ç—ã—Ö —Å–æ–æ–±—â–µ–Ω–∏–π –æ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π. –î–∞–≤–∞–π—Ç–µ —Ä–∞–∑–±–µ—Ä—ë–º –µ–≥–æ –ø–æ–¥—Ä–æ–±–Ω–æ. <br>
[–†–∞–∑—Ä–∞–±–æ—Ç–∫–∞ –¢–µ–ª–µ–≥—Ä–∞–º –±–æ—Ç–æ–≤](https://else.com.ru "–†–∞–∑—Ä–∞–±–æ—Ç–∫–∞ –¢–µ–ª–µ–≥—Ä–∞–º –±–æ—Ç–æ–≤") -> https://else.com.ru/

## –ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ –∫–ª–∞—Å—Å–∞
`AntiFloodMiddleware` - —ç—Ç–æ –ø—Ä–æ–º–µ–∂—É—Ç–æ—á–Ω–æ–µ –ø—Ä–æ–≥—Ä–∞–º–º–Ω–æ–µ –æ–±–µ—Å–ø–µ—á–µ–Ω–∏–µ (middleware), –∫–æ—Ç–æ—Ä–æ–µ:

<ol>
  <li>–û—Ç—Å–ª–µ–∂–∏–≤–∞–µ—Ç —á–∞—Å—Ç–æ—Ç—É —Å–æ–æ–±—â–µ–Ω–∏–π –æ—Ç –∫–∞–∂–¥–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è</li>
  <li>–ë–ª–æ–∫–∏—Ä—É–µ—Ç –æ–±—Ä–∞–±–æ—Ç–∫—É —Å–æ–æ–±—â–µ–Ω–∏–π, –µ—Å–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –ø—Ä–µ–≤—ã—Å–∏–ª –ª–∏–º–∏—Ç</li>
  <li>–û—Ç–ø—Ä–∞–≤–ª—è–µ—Ç –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é –æ –ø—Ä–µ–≤—ã—à–µ–Ω–∏–∏ –ª–∏–º–∏—Ç–∞</li>
</ol>
    
## –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è
```
  def __init__(self, limit: int = 5, interval: float = 10.0):
      """
      :param limit: –ú–∞–∫—Å–∏–º–∞–ª—å–Ω–æ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —Å–æ–æ–±—â–µ–Ω–∏–π –∑–∞ –∏–Ω—Ç–µ—Ä–≤–∞–ª
      :param interval: –ò–Ω—Ç–µ—Ä–≤–∞–ª –≤—Ä–µ–º–µ–Ω–∏ –≤ —Å–µ–∫—É–Ω–¥–∞—Ö
      """
      self.limit = limit
      self.interval = interval
      self.user_messages = defaultdict(list)
      super().__init__()
      logger.info(f"Initialized AntiFloodMiddleware with limit={limit}/per {interval}s")
```


+ `limit` - –º–∞–∫—Å–∏–º–∞–ª—å–Ω–æ–µ —Ä–∞–∑—Ä–µ—à—ë–Ω–Ω–æ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —Å–æ–æ–±—â–µ–Ω–∏–π –∑–∞ –∏–Ω—Ç–µ—Ä–≤–∞–ª (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é 5)</li>
+ `interval` - –≤—Ä–µ–º–µ–Ω–Ω–æ–π –∏–Ω—Ç–µ—Ä–≤–∞–ª –≤ —Å–µ–∫—É–Ω–¥–∞—Ö (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é 10.0)</li>
+ `user_messages` - —Å–ª–æ–≤–∞—Ä—å –¥–ª—è —Ö—Ä–∞–Ω–µ–Ω–∏—è –≤—Ä–µ–º–µ–Ω–∏ —Å–æ–æ–±—â–µ–Ω–∏–π –∫–∞–∂–¥–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è</li>

## –û—Å–Ω–æ–≤–Ω–∞—è –ª–æ–≥–∏–∫–∞ —Ä–∞–±–æ—Ç—ã
–ú–µ—Ç–æ–¥ `__call__` –≤—ã–ø–æ–ª–Ω—è–µ—Ç—Å—è –¥–ª—è –∫–∞–∂–¥–æ–≥–æ –≤—Ö–æ–¥—è—â–µ–≥–æ —Å–æ–±—ã—Ç–∏—è:
```
  async def __call__(
      self,
      handler: Callable[[Update, Dict[str, Any]], Awaitable[Any]],
      event: Update,
      data: Dict[str, Any]
  ) -> Any:
```

1. –û–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ —Ç–∏–ø–∞ —Å–æ–±—ã—Ç–∏—è
```
  real_event = None
  if event.message:
      real_event = event.message
  
  if real_event is None or not hasattr(real_event, 'from_user'):
      logger.debug("Unsupported event type, skipping flood check")
      return await handler(event, data)
```
–ö–æ–¥ –ø—Ä–æ–≤–µ—Ä—è–µ—Ç, —è–≤–ª—è–µ—Ç—Å—è –ª–∏ —Å–æ–±—ã—Ç–∏–µ —Å–æ–æ–±—â–µ–Ω–∏–µ–º –∏ –∏–º–µ–µ—Ç –ª–∏ –æ–Ω–æ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ. –ï—Å–ª–∏ –Ω–µ—Ç - –ø—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞ —Ñ–ª—É–¥ –ø—Ä–æ–ø—É—Å–∫–∞–µ—Ç—Å—è.

2. –ü–æ–ª—É—á–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
```
  user_id = real_event.from_user.id
  current_time = time.time()
```
–ò–∑–≤–ª–µ–∫–∞–µ—Ç—Å—è ID –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∏ —Ç–µ–∫—É—â–µ–µ –≤—Ä–µ–º—è.

3. –û—á–∏—Å—Ç–∫–∞ —Å—Ç–∞—Ä—ã—Ö —Å–æ–æ–±—â–µ–Ω–∏–π
```
  self.user_messages[user_id] = [
      t for t in self.user_messages[user_id]
      if current_time - t < self.interval
  ]
```
–£–¥–∞–ª—è—é—Ç—Å—è –∑–∞–ø–∏—Å–∏ –æ —Å–æ–æ–±—â–µ–Ω–∏—è—Ö, –∫–æ—Ç–æ—Ä—ã–µ –≤—ã—à–ª–∏ –∑–∞ –ø—Ä–µ–¥–µ–ª—ã –≤—Ä–µ–º–µ–Ω–Ω–æ–≥–æ –∏–Ω—Ç–µ—Ä–≤–∞–ª–∞.

4. –î–æ–±–∞–≤–ª–µ–Ω–∏–µ —Ç–µ–∫—É—â–µ–≥–æ —Å–æ–æ–±—â–µ–Ω–∏—è
```
  self.user_messages[user_id].append(current_time)
  logger.debug(f"User {user_id} has {len(self.user_messages[user_id])} requests in last {self.interval}s")
```
–§–∏–∫—Å–∏—Ä—É–µ—Ç—Å—è –≤—Ä–µ–º—è —Ç–µ–∫—É—â–µ–≥–æ —Å–æ–æ–±—â–µ–Ω–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è.

5. –ü—Ä–æ–≤–µ—Ä–∫–∞ –ª–∏–º–∏—Ç–∞
```
  if len(self.user_messages[user_id]) > self.limit:
      logger.warning(f"Flood detected from user {user_id} ({len(self.user_messages[user_id])} requests)")
  
      if isinstance(real_event, Message):
          try:
              await real_event.answer("‚ö†Ô∏è –°–ª–∏—à–∫–æ–º –º–Ω–æ–≥–æ –∑–∞–ø—Ä–æ—Å–æ–≤! –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –ø–æ–¥–æ–∂–¥–∏—Ç–µ.")
              logger.info(f"Sent flood warning to user {user_id}")
          except TelegramAPIError as e:
              logger.error(f"Failed to send flood warning: {str(e)}")
  
      return None
```
–ï—Å–ª–∏ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —Å–æ–æ–±—â–µ–Ω–∏–π –ø—Ä–µ–≤—ã—à–∞–µ—Ç –ª–∏–º–∏—Ç:

+ –ó–∞–ø–∏—Å—ã–≤–∞–µ—Ç—Å—è –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–µ –≤ –ª–æ–≥
+ –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç—Å—è —Å–æ–æ–±—â–µ–Ω–∏–µ —Å –ø—Ä–æ—Å—å–±–æ–π –ø–æ–¥–æ–∂–¥–∞—Ç—å
+ –î–∞–ª—å–Ω–µ–π—à–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞ —Å–æ–æ–±—â–µ–Ω–∏—è –ø—Ä–µ—Ä—ã–≤–∞–µ—Ç—Å—è (–≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç—Å—è None)

6. –û–±—Ä–∞–±–æ—Ç–∫–∞ –∏—Å–∫–ª—é—á–µ–Ω–∏–π
```
  except Exception as e:
      logger.exception(f"Error in AntiFloodMiddleware: {str(e)}")
      return await handler(event, data)
```
–ü—Ä–∏ –≤–æ–∑–Ω–∏–∫–Ω–æ–≤–µ–Ω–∏–∏ –æ—à–∏–±–∫–∏ –æ–Ω–∞ –ª–æ–≥–∏—Ä—É–µ—Ç—Å—è, –Ω–æ –æ–±—Ä–∞–±–æ—Ç–∫–∞ —Å–æ–æ–±—â–µ–Ω–∏—è –ø—Ä–æ–¥–æ–ª–∂–∞–µ—Ç—Å—è.

## –ü—Ä–∞–∫—Ç–∏—á–µ—Å–∫–æ–µ –ø—Ä–∏–º–µ–Ω–µ–Ω–∏–µ
–≠—Ç–æ—Ç middleware –ø–æ–ª–µ–∑–µ–Ω –¥–ª—è:

+ –ó–∞—â–∏—Ç—ã –æ—Ç –±–æ—Ç–æ–≤ –∏ —Å–ø–∞–º–µ—Ä–æ–≤
+ –ü—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–µ–Ω–∏—è DDoS-–∞—Ç–∞–∫ –Ω–∞ –±–æ—Ç–∞
+ –û–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è –Ω–∞–≥—Ä—É–∑–∫–∏ –Ω–∞ —Å–µ—Ä–≤–µ—Ä
+ –£–ª—É—á—à–µ–Ω–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–æ–≥–æ –æ–ø—ã—Ç–∞ (–ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–µ–Ω–∏–µ —Å–ª—É—á–∞–π–Ω–æ–≥–æ —Ñ–ª—É–¥–∞)

## –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤
–ü—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ middleware –º–æ–∂–Ω–æ –Ω–∞—Å—Ç—Ä–æ–∏—Ç—å:

+ `limit` - –∫–∞–∫ —á–∞—Å—Ç–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –º–æ–∂–µ—Ç –æ—Ç–ø—Ä–∞–≤–ª—è—Ç—å —Å–æ–æ–±—â–µ–Ω–∏—è
+ `interval` - –∑–∞ –∫–∞–∫–æ–π –ø–µ—Ä–∏–æ–¥ –≤—Ä–µ–º–µ–Ω–∏ —É—á–∏—Ç—ã–≤–∞—é—Ç—Å—è —Å–æ–æ–±—â–µ–Ω–∏—è

–ü—Ä–∏–º–µ—Ä:
```
  # 3 —Å–æ–æ–±—â–µ–Ω–∏—è –≤ 5 —Å–µ–∫—É–Ω–¥
  middleware = AntiFloodMiddleware(limit=3, interval=5.0)
```

## –ó–∞–∫–ª—é—á–µ–Ω–∏–µ
–ü—Ä–µ–¥—Å—Ç–∞–≤–ª–µ–Ω–Ω—ã–π –∫–æ–¥ - —ç—Ç–æ —ç—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–æ–µ —Ä–µ—à–µ–Ω–∏–µ –¥–ª—è –∑–∞—â–∏—Ç—ã Telegram –±–æ—Ç–∞ –æ—Ç –∑–ª–æ—É–ø–æ—Ç—Ä–µ–±–ª–µ–Ω–∏–π. –û–Ω –≥–∏–±–∫–æ –Ω–∞—Å—Ç—Ä–∞–∏–≤–∞–µ—Ç—Å—è, –ª–æ–≥–∏—Ä—É–µ—Ç —Å–≤–æ—é —Ä–∞–±–æ—Ç—É –∏ –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç –æ—à–∏–±–∫–∏.
<br>
<blockquote>
<b>–ù—É–∂–µ–Ω –Ω–∞–¥–µ–∂–Ω—ã–π Telegram-–±–æ—Ç —Å –∑–∞—â–∏—Ç–æ–π –æ—Ç —Ñ–ª—É–¥–∞ –∏ —Å–ø–∞–º–∞?</b>

–ö–æ–º–∞–Ω–¥–∞ ELSE (https://else.com.ru/) –ø—Ä–æ—Ñ–µ—Å—Å–∏–æ–Ω–∞–ª—å–Ω–æ —Ä–∞–∑—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç Telegram-–±–æ—Ç–æ–≤ –ª—é–±–æ–π —Å–ª–æ–∂–Ω–æ—Å—Ç–∏ ‚Äî –æ—Ç –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏—Ö —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π –¥–æ —Å–ª–æ–∂–Ω—ã—Ö CRM-—Å–∏—Å—Ç–µ–º —Å –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–µ–π –ø–ª–∞—Ç–µ–∂–µ–π –∏ –±–∞–∑ –¥–∞–Ω–Ω—ã—Ö. –ú—ã –æ–±–µ—Å–ø–µ—á–∏–≤–∞–µ–º:<br>

‚úÖ –ó–∞—â–∏—Ç—É –æ—Ç —Å–ø–∞–º–∞ (–∫–∞–∫ –≤ —ç—Ç–æ–º –ø—Ä–∏–º–µ—Ä–µ)<br>
‚úÖ –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—é —Å API, –±–∞–∑–∞–º–∏ –¥–∞–Ω–Ω—ã—Ö –∏ –≤–Ω–µ—à–Ω–∏–º–∏ —Å–µ—Ä–≤–∏—Å–∞–º–∏<br>
‚úÖ –ì–∏–±–∫—É—é –Ω–∞—Å—Ç—Ä–æ–π–∫—É –ø–æ–¥ –≤–∞—à–∏ –±–∏–∑–Ω–µ—Å-–∑–∞–¥–∞—á–∏<br>
‚úÖ –ë—ã—Å—Ç—Ä—É—é –∏ —Å—Ç–∞–±–∏–ª—å–Ω—É—é —Ä–∞–±–æ—Ç—É<br>

–•–æ—Ç–∏—Ç–µ —Ç–∞–∫–æ–≥–æ –∂–µ –±–æ—Ç–∞? –û—Å—Ç–∞–≤—å—Ç–µ –∑–∞—è–≤–∫—É –Ω–∞ else.com.ru ‚Äî –∏ –º—ã —Ä–µ–∞–ª–∏–∑—É–µ–º –≤–∞—à –ø—Ä–æ–µ–∫—Ç —Å –Ω—É–ª—è! üöÄ<br>
[–°–æ–∑–¥–∞–Ω–∏–µ –¢–µ–ª–µ–≥—Ä–∞–º –±–æ—Ç–æ–≤](https://else.com.ru "–†–∞–∑—Ä–∞–±–æ—Ç–∫–∞ –¢–µ–ª–µ–≥—Ä–∞–º –±–æ—Ç–æ–≤") -> https://else.com.ru/
</blockquote>
    

    
